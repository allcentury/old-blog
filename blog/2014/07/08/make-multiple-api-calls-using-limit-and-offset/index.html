
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Make Multiple API Calls Using Limit &amp; Offset - Anthony Ross' Blog</title>
  <meta name="author" content="Anthony Ross">

  
  <meta name="description" content="Earlier today I needed to get some data from the Yelp API but I didn&rsquo;t need
anything more than a list of businesses within a particular state. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://allcentury.github.io/blog/2014/07/08/make-multiple-api-calls-using-limit-and-offset">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Anthony Ross' Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-48296635-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Anthony Ross' Blog</a></h1>
  
    <h2>Back to Our Regularly Scheduled Programming</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:allcentury.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Make Multiple API Calls Using Limit &amp; Offset</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-08T14:59:53-04:00" pubdate data-updated="true">Jul 8<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Earlier today I needed to get some data from the Yelp API but I didn&rsquo;t need
anything more than a list of businesses within a particular state.  I did an
initial search on Yelp&rsquo;s site and saw there were over 300 businesses that met
my search criteria so I decided to write a quick program to get all of the
information I needed.</p>

<p>If you&rsquo;re reading this you&rsquo;re probably aware that Yelp (like many API&rsquo;s) has a
limit of the search results, in thise case it&rsquo;s 20 (this is as of v2 of their
API).  I&rsquo;ve made my code easy to change so by all means replace any of my
variables with your own criteria.  I&rsquo;m going to put up a gist of all of the code though.</p>

<p>First things first, you need to register your app with Yelp <a
href="http://www.yelp.com/developers/getting_started">here</a>.  From there you
need to copy the 4 codes they give you into this:</p>

<figure class='code'><figcaption><span>yelp-api.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;pry&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;oauth&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">consumer_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'><span class="n">consumer_secret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'><span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'><span class="n">token_secret</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">api_host</span> <span class="o">=</span> <span class="s1">&#39;api.yelp.com&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">consumer</span> <span class="o">=</span> <span class="ss">OAuth</span><span class="p">:</span><span class="ss">:Consumer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">consumer_secret</span><span class="p">,</span> <span class="p">{</span><span class="ss">:site</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">api_host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
</span><span class='line'><span class="n">access_token</span> <span class="o">=</span> <span class="ss">OAuth</span><span class="p">:</span><span class="ss">:AccessToken</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token_secret</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve left my gem list as-is and we&rsquo;ll touch on most of these but I suspect you already know what they do.</p>

<p>Ok, so the first goal is make an API call to make sure we get something that we suspect.  Let&rsquo;s add this to our code:</p>

<figure class='code'><figcaption><span>yelp-api.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">search_term</span> <span class="o">=</span> <span class="s2">&quot;flowers%20candy&quot;</span>
</span><span class='line'><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;massachusetts&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/v2/search?term=</span><span class="si">#{</span><span class="n">search_term</span><span class="si">}</span><span class="s2">&amp;location=</span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">response</span><span class="o">[</span><span class="s2">&quot;businesses&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we&rsquo;re searching &ldquo;flowers candy&rdquo; with a location of Massachusetts.  This is
not only a tutorial on API calls but also a friendly reminder to buy your SO
some flowers and/or candy.  You can thank me later.</p>

<p>You should get a response like this:
<img src="http://i.imgur.com/OscOauk.png"></p>

<p>So that response has all the data we want and yelp is kind enough to tell us that 316 businesses meet that search criteria.  That&rsquo;s great and all but they only give us the first 20 what if we want all of them?  We could do a loop 16 times (318 total / 20 per fetch) but how do we change our API call to get the next 20 and the next 20 and so on.  Thankfully almost all API&rsquo;s that have JSON response will give you a way to paginate or limit/offset.  Here Yelp wants us to use limit/offset and you do that by adding that to your API calls like so:</p>

<figure class='code'><figcaption><span>yelp-api.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resp</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">limit</span> <span class="o">=</span> <span class="mi">20</span>
</span><span class='line'><span class="k">while</span> <span class="o">!</span><span class="p">(</span><span class="n">response</span><span class="o">[</span><span class="s2">&quot;businesses&quot;</span><span class="o">].</span><span class="n">empty?</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/v2/search?term=</span><span class="si">#{</span><span class="n">search_term</span><span class="si">}</span><span class="s2">&amp;location=</span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">&amp;limit=</span><span class="si">#{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&amp;offset=</span><span class="si">#{</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>  <span class="n">resp</span> <span class="o">&lt;&lt;</span> <span class="n">response</span>
</span><span class='line'>  <span class="n">offset</span> <span class="o">+=</span> <span class="n">limit</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well this code should be somewhat straightforward but I&rsquo;ll go through the
important parts.  We start with an offset of 0 that&rsquo;s because we want to start
at the beginning of the API response.  The limit gives us how many we want at a
time.  So with an offset of 0 and a limit of 20, this will give us the first 20
businesses that meet our search criteria.  We loop again and as long as the
response[&ldquo;businesses&rdquo;] array is not empty we continue on (we know there are a
lot more than 20 results so it loops again).  This time, offset has increased by
20 so we start at the 21st element and get another 20.  We keep doing this
until we have all of them.</p>

<p>From there you can do whatever you&rsquo;d like with all that data by looping over the resp array we&rsquo;ve been appending the responses into.  I actually needed to put these into a CSV which I trust you already know how to do. Hope that was helpful!</p>

<p>You can find a gist of the entire code <a href="https://gist.github.com/3c899bbf8033be08c615">here</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Anthony Ross</span></span>

      








  


<time datetime="2014-07-08T14:59:53-04:00" pubdate data-updated="true">Jul 8<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://allcentury.github.io/blog/2014/07/08/make-multiple-api-calls-using-limit-and-offset/" data-via="djanthonyross" data-counturl="http://allcentury.github.io/blog/2014/07/08/make-multiple-api-calls-using-limit-and-offset/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/07/setting-up-bootstrap-flash-messages-in-rails-4/" title="Previous Post: Setting up Bootstrap Flash Messages in Rails 4">&laquo; Setting up Bootstrap Flash Messages in Rails 4</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/08/make-multiple-api-calls-using-limit-and-offset/">Make Multiple API Calls Using Limit &amp; Offset</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/07/setting-up-bootstrap-flash-messages-in-rails-4/">Setting Up Bootstrap Flash Messages in Rails 4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/03/geocoder-rspec-3-and-rails-4/">Geocoder, RSpec 3 and Rails 4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/04/acceptance-testing/">Acceptance Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/21/ar-equals-launcher-star-5/">AR = Launcher * .5</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/allcentury">@allcentury</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'allcentury',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/+AnthonyRossMusic?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Anthony Ross -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
